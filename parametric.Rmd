---
title: "Parametric"
author: "Jibei Zheng jz3425"
output: pdf_document
---

```{r setup, include = FALSE, warning = FALSE, message = FALSE}
library(survival)
library(tidyverse)
library(flexsurv)

theme_set(theme_minimal())
```

```{r}
lung_df = lung %>% 
  mutate_at(c(1, 3, 5, 6), .funs = ~as.factor(.))
```

## Model Checking

Plot $-log\hat{S}(t)$

```{r}
lung_fit = survfit(Surv(time, status == 2) ~ sex, 
                   data = lung_df)

plot(lung_fit, col = c("blue", "red"), 
     fun = "cumhaz", xlab = "Days", ylab = "-logS(t)", 
     main = "Negative Log of Estimated Survival Functions")
legend("topleft", legend = c("Male", "Female"), 
       title = "Sex", col = c("blue", "red"), lty = 1)
```

The curve for males is close to a straight line, while the curve for females is obviously non-linear, indicating a better choice of the Weibull distribution.

Plot $log(-logS(t))$

```{r, fig.height=5}
x_tick = c(5, 10, 20, 50, 100, 200, 500, 1000)
log_x = round(log(x_tick), 1)

plot(lung_fit, col = c("blue", "red"), fun = "cloglog", 
     xlab = "log(Days)", ylab = "log{-logS(t)}", 
     xaxt = "n", main = "Log of Negative Log of Estimated Survival Functions")
axis(1, at = x_tick, labels = log_x)
legend("topleft", legend = c("Male", "Female"), 
       title = "Sex", col = c("blue", "red"), lty = 1)
```

The slope of the male curve is close to 1, while the slope of the female curve is larger than 1, also indicating a Weibull distribution.

### Fit exponential and Weilbull model

```{r}
#parametric survival function
fit_exp = flexsurvreg(Surv(time, status == 2) ~ sex, 
                      data = lung_df, dist = "exp")
fit_web <- flexsurvreg(Surv(time, status == 2) ~ sex, 
                       data = lung_df, dist = "weibull")

#exp parameter estimation and CI
fit_exp

#Weibull parameter estimation and CI
fit_web
```



```{r, fig.align='center', fig.height=6}
#plot km, exp fitted and web fitted
plot(fit_web, 
     lwd = 2, lwd.obs = 1, 
     col = c("blue", "red"), col.obs = c("skyblue", "pink"),
     xlab = "Days", ylab = "Survival Probability", 
     main = "KM and Parametric Est with 95% CI")
plot(fit_exp, add = TRUE, 
     lwd = 2, col = c("blue4", "brown4"), lty = "longdash")
legend("topright", legend = c("Obs M", "Obs F", "Exp M", "Exp F", "Web M", "Web F"), 
       col = c("skyblue", "pink", "blue4", "brown4", "blue", "red"),
       lty = c("solid", "solid", "longdash", "longdash", "solid", "solid"),
       lwd = c(1,1,2,2,2,2))

```

From the plot we can see that fitting a Weibull distribution is actually more precise than an exponential distribution.